{
  "version": 3,
  "sources": ["../../node_modules/@yume-chan/adb-credential-web/src/index.ts"],
  "sourcesContent": ["// cspell: ignore RSASSA\n\nimport type { AdbCredentialStore, AdbPrivateKey } from \"@yume-chan/adb\";\n\nfunction openDatabase() {\n    return new Promise<IDBDatabase>((resolve, reject) => {\n        const request = indexedDB.open(\"Tango\", 1);\n        request.onerror = () => {\n            reject(request.error!);\n        };\n        request.onupgradeneeded = () => {\n            const db = request.result;\n            db.createObjectStore(\"Authentication\", { autoIncrement: true });\n        };\n        request.onsuccess = () => {\n            const db = request.result;\n            resolve(db);\n        };\n    });\n}\n\nasync function saveKey(key: Uint8Array): Promise<void> {\n    const db = await openDatabase();\n\n    return new Promise((resolve, reject) => {\n        const transaction = db.transaction(\"Authentication\", \"readwrite\");\n        const store = transaction.objectStore(\"Authentication\");\n        const putRequest = store.add(key);\n        putRequest.onerror = () => {\n            reject(putRequest.error!);\n        };\n        putRequest.onsuccess = () => {\n            resolve();\n        };\n        transaction.onerror = () => {\n            reject(transaction.error!);\n        };\n        transaction.oncomplete = () => {\n            db.close();\n        };\n    });\n}\n\nasync function getAllKeys() {\n    const db = await openDatabase();\n\n    return new Promise<Uint8Array[]>((resolve, reject) => {\n        const transaction = db.transaction(\"Authentication\", \"readonly\");\n        const store = transaction.objectStore(\"Authentication\");\n        const getRequest = store.getAll();\n        getRequest.onerror = () => {\n            reject(getRequest.error!);\n        };\n        getRequest.onsuccess = () => {\n            resolve(getRequest.result as Uint8Array[]);\n        };\n        transaction.onerror = () => {\n            reject(transaction.error!);\n        };\n        transaction.oncomplete = () => {\n            db.close();\n        };\n    });\n}\n\n/**\n * An `AdbCredentialStore` implementation that creates RSA private keys using Web Crypto API\n * and stores them in IndexedDB.\n */\nexport default class AdbWebCredentialStore implements AdbCredentialStore {\n    readonly #appName: string;\n\n    constructor(appName = \"Tango\") {\n        this.#appName = appName;\n    }\n\n    /**\n     * Generates a RSA private key and store it into LocalStorage.\n     *\n     * Calling this method multiple times will overwrite the previous key.\n     *\n     * @returns The private key in PKCS #8 format.\n     */\n    async generateKey(): Promise<AdbPrivateKey> {\n        const { privateKey: cryptoKey } = await crypto.subtle.generateKey(\n            {\n                name: \"RSASSA-PKCS1-v1_5\",\n                modulusLength: 2048,\n                // 65537\n                publicExponent: new Uint8Array([0x01, 0x00, 0x01]),\n                hash: \"SHA-1\",\n            },\n            true,\n            [\"sign\", \"verify\"],\n        );\n\n        const privateKey = new Uint8Array(\n            await crypto.subtle.exportKey(\"pkcs8\", cryptoKey),\n        );\n        await saveKey(privateKey);\n\n        return {\n            buffer: privateKey,\n            name: `${this.#appName}@${globalThis.location.hostname}`,\n        };\n    }\n\n    /**\n     * Yields the stored RSA private key.\n     *\n     * This method returns a generator, so `for await...of...` loop should be used to read the key.\n     */\n    async *iterateKeys(): AsyncGenerator<AdbPrivateKey, void, void> {\n        for (const key of await getAllKeys()) {\n            yield {\n                buffer: key,\n                name: `${this.#appName}@${globalThis.location.hostname}`,\n            };\n        }\n    }\n}\n"],
  "mappings": ";;;;;;;;;;AAIA,WAAS,eAAY;AACjB,WAAO,IAAI,QAAqB,CAAC,SAAS,WAAU;AAChD,YAAM,UAAU,UAAU,KAAK,SAAS,CAAC;AACzC,cAAQ,UAAU,MAAK;AACnB,eAAO,QAAQ,KAAM;MACzB;AACA,cAAQ,kBAAkB,MAAK;AAC3B,cAAM,KAAK,QAAQ;AACnB,WAAG,kBAAkB,kBAAkB,EAAE,eAAe,KAAI,CAAE;MAClE;AACA,cAAQ,YAAY,MAAK;AACrB,cAAM,KAAK,QAAQ;AACnB,gBAAQ,EAAE;MACd;IACJ,CAAC;EACL;AAEA,iBAAe,QAAQ,KAAe;AAClC,UAAM,KAAK,MAAM,aAAY;AAE7B,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAU;AACnC,YAAM,cAAc,GAAG,YAAY,kBAAkB,WAAW;AAChE,YAAM,QAAQ,YAAY,YAAY,gBAAgB;AACtD,YAAM,aAAa,MAAM,IAAI,GAAG;AAChC,iBAAW,UAAU,MAAK;AACtB,eAAO,WAAW,KAAM;MAC5B;AACA,iBAAW,YAAY,MAAK;AACxB,gBAAO;MACX;AACA,kBAAY,UAAU,MAAK;AACvB,eAAO,YAAY,KAAM;MAC7B;AACA,kBAAY,aAAa,MAAK;AAC1B,WAAG,MAAK;MACZ;IACJ,CAAC;EACL;AAEA,iBAAe,aAAU;AACrB,UAAM,KAAK,MAAM,aAAY;AAE7B,WAAO,IAAI,QAAsB,CAAC,SAAS,WAAU;AACjD,YAAM,cAAc,GAAG,YAAY,kBAAkB,UAAU;AAC/D,YAAM,QAAQ,YAAY,YAAY,gBAAgB;AACtD,YAAM,aAAa,MAAM,OAAM;AAC/B,iBAAW,UAAU,MAAK;AACtB,eAAO,WAAW,KAAM;MAC5B;AACA,iBAAW,YAAY,MAAK;AACxB,gBAAQ,WAAW,MAAsB;MAC7C;AACA,kBAAY,UAAU,MAAK;AACvB,eAAO,YAAY,KAAM;MAC7B;AACA,kBAAY,aAAa,MAAK;AAC1B,WAAG,MAAK;MACZ;IACJ,CAAC;EACL;AA/DA;AAqEA,MAAqB,wBAArB,MAA0C;IAGtC,YAAY,UAAU,SAAO;AAFpB;AAGL,yBAAK,UAAW;IACpB;;;;;;;;IASA,MAAM,cAAW;AACb,YAAM,EAAE,YAAY,UAAS,IAAK,MAAM,OAAO,OAAO,YAClD;QACI,MAAM;QACN,eAAe;;QAEf,gBAAgB,IAAI,WAAW,CAAC,GAAM,GAAM,CAAI,CAAC;QACjD,MAAM;SAEV,MACA,CAAC,QAAQ,QAAQ,CAAC;AAGtB,YAAM,aAAa,IAAI,WACnB,MAAM,OAAO,OAAO,UAAU,SAAS,SAAS,CAAC;AAErD,YAAM,QAAQ,UAAU;AAExB,aAAO;QACH,QAAQ;QACR,MAAM,GAAG,mBAAK,SAAQ,IAAI,WAAW,SAAS,QAAQ;;IAE9D;;;;;;IAOA,OAAO,cAAW;AACd,iBAAW,OAAO,MAAM,WAAU,GAAI;AAClC,cAAM;UACF,QAAQ;UACR,MAAM,GAAG,mBAAK,SAAQ,IAAI,WAAW,SAAS,QAAQ;;MAE9D;IACJ;;AAjDS;",
  "names": []
}
